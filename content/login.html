<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Chat - Login</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    </head>
    <body>
        <div class="pageContainer">
            <div class="loginContainer">
                <h2>Login First!</h2>
                <form id="loginForm" action="">
                    <input type="text" required maxlength="32" minlength="1" name="username" id="login-username" placeholder="Username: ..."></input>
                    <input type="password" required minlength="6" maxlength="16" name="password" id="login-password" placeholder="Password: ..."></input>
                    <button type="submit">submit</button>
                </form>
            </div>
            <div class="singupContainer">
                <h2>Signup First!</h2>
                <form id="signupForm" action="">
                    <input required type="text" maxlength="32" minlength="1" name="username" pattern="[a-z0-9]+" id="signup-username" placeholder="username: Eng small letter & number only (Characters: Max: 32, Min: 1)"></input>
                    <input required type="password" name="password" minlength="6" maxlength="16" id="signup-password" placeholder="Password: (Characters: Max: 16, Min: 6)"></input>
                    <labal id="confirmText">The password must be match</labal>
                    <input required type="password" name="passwordConfirm"  minlength="6" maxlength="16" id="passwordConfirm" oninput="confirmCheck(this)" placeholder="Confirm your password: ..."></input>
                    <input required type="email" name="email" id="email" placeholder="Email: ..."></input>
                    <input required type="phone" name="phoneNo" id="phoneNo" placeholder="Phone: ..."></input>
                    <button type="submit" disabled="true" id="signupBtn">submit</button>
                </form>
            </div>
        </div>
    </body>
    <script>
        var register = function(){
            $.ajax({
                type: 'POST',
                url: '/users/signup',
                dataType: 'json',
                contentType: 'application/json',
                data: {}
            })
        }

        $('#signupForm').submit( function(event) {
            event.preventDefault();

            var data = {
                username : $('#signup-username').val(),
                password : $('#signup-password').val(),
                passwordConfirm : $('#passwordConfirm').val(),
                email : $('#email').val(),
                phoneNo : $('#phoneNo').val()
            }

            $.ajax({
                type: 'POST',
                url: '/users/signup',
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                async: false,
                data: JSON.stringify(data),
                error: function(err){              
                    if(err.responseJSON.error.statusCode === 400){
                        var fieldName = err.responseJSON.message.substring(err.responseJSON.message.lastIndexOf(':') + 1).trim();
                        if(fieldName === 'phoneNo') fieldName = 'phone number';
                        var errMsg = 'Please use another value for ' + fieldName;
                        alert(errMsg);
                    }
                },
                success: function(data){
                    window.location = '/chatlist.html';
                }                
            });
        });

        //Common function
        function login(){
            var data = {
                username : $('#login-username').val(),
                password : $('#login-password').val()
            }
            
            $.ajax({
                type: 'POST',
                url: '/users/login',
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                async: false,
                data: JSON.stringify(data),
                error: function(err){
                    console.log(err);
                    if(err.status === 404){
                        var errMsg = 'Incorrect password or username';
                        alert(errMsg);
                    }
                },
                success: function(){
                    window.location = '/chatlist.html';
                }
            });
        }

        $('#loginForm').submit( function(event) {
            event.preventDefault();
            login();
        });

        //function to check if password confirm are matched
        function confirmCheck(input) {
            if (input.value === $('#signup-password').val()) {
                $('#confirmText').hide();
                $('#signupBtn').prop('disabled', false);
            }else{
                $('#confirmText').show();
            }
        }
    </script>
</html>