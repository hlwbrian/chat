<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Chat - Chatrooms list</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    </head>
    <body>
        <div id="chatlistPage">
            <!-- show personal info -->
            <h3>Personal Info:</h3>
            <div class="userInfo">
                <p class="email"></p>
                <p class="phone"></p>
                <p class="userID"></p>
            </div>

            <!-- Chatroom list -->
            <h3>Chatroom list</h3>
            <ul id="chatlist"></ul>

            <!-- create chatroom -->
            <h3>Create chat</h3>
            <form id="createChat">
                <p>Add your friend's' ID: e.g. john#315</p>
                <input type="text" placeholder="john#315" pattern="[a-z0-9]+#[0-9]+" required id="username">
                <input type="text" placeholder="chatroom name" required id="chatroomName" minlength="1" maxlength="32">
                <button type="submit">create</button>
            </form>
        </div>
    </body>
    <script>
        //common function
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        //Load chat list
        (function init(){
            $.ajax
            ({
                type: "GET",
                url: "/chat/getChat",
                dataType: 'json',
                async: false,
                headers: {
                    "authorization": "Bearer " + getCookie('chatJWT')
                },
                success:function(data) {
                    //insert user data
                    $('.phone').text(data.request.phone);
                    $('.email').text(data.request.email);
                    $('.userID').text(data.request.username + '#' + data.request.userID);

                    //insert chatlist data
                    if(data.records.length > 0){
                        var html = '', datetime, datetimeFormat;
                        for(var i = 0; i < data.records.length; i++){                            
                            html += '<li data-id="'+data.records[i].chatID+'">' + 
                            'Chatroom name : ' + data.records[i]['chatroomName'] + '<br/>';
                            
                            if(data.records[i].conversations.length > 0){
                                datetime = new Date(data.records[i].conversations[i]['timestamp']);
                                datetimeFormat = datetime.getFullYear() + '/' + datetime.getMonth() + '/' + datetime.getDate() + ' ' + datetime.getMinutes() + ':' + datetime.getSeconds();
                                html += data.records[i].conversations[i]['message'] + ' ' + datetimeFormat;
                            }
                            
                            html += '</li>';
                        }
                        

                        $('#chatlist').append(html);
                    }
                }
            });
        })();

        //Create chat
        $('#createChat').submit(function(event){
            event.preventDefault();
            var data ={
                username:  $('#username').val(),
                chatroom: $('#chatroomName').val()
            }
            
            $.ajax
            ({
                type: "POST",
                url: "/chat/create",
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                async: false,
                data: JSON.stringify(data),
                headers: {
                    "authorization": "Bearer " + getCookie('chatJWT')
                },
                success:function(data) {
                    //insert chatlist data
                    var html='', datetime, datetimeFormat;
                    html += '<li data-id="'+data.records.chatID+'">' + 
                         'Chatroom name : ' + data.records['chatroomName'] + '</li>';
                    $('#chatlist').append(html);
                }
            });
        });
    </script>
</html>