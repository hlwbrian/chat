<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Chat - Chatrooms list</title>
    </head>
    <body>
        <div id="chatlistPage">
            <!-- show personal info -->
            <h3>Personal Info:</h3>
            <div class="userInfo">
                <p class="email"></p>
                <p class="phone"></p>
                <p class="userID"></p>
                <img class="icon"/>
            </div>

            <!-- Chatroom list -->
            <h3>Chatroom list</h3>
            <ul id="chatlist"></ul>

            <!-- create chatroom -->
            <h3>Create chat</h3>
            <form id="createChat">
                <p>Add your friend's' ID: e.g. john#315</p>
                <input type="text" placeholder="john#315" pattern="[a-z0-9]+#[0-9]+" required id="username">
                <input type="text" placeholder="chatroom name" required id="chatroomName" minlength="1" maxlength="32">
                <button type="submit">create</button>
            </form>

            <!-- Update personal info -->
            <h3>Update username</h3>
            <form id="updateName">
                <input required type="text" maxlength="32" minlength="1" name="username" pattern="[a-z0-9]+" id="update-username" placeholder="username: Eng small letter & number only (Characters: Max: 32, Min: 1)"></input>
                <input required type="password" name="password" minlength="6" maxlength="16" id="password" placeholder="Password: (Characters: Max: 16, Min: 6)">
                <button type="submit">confirm</button>
            </form>


            <form id="fileUpload" 
                action='/users/addImage' 
                method='post' 
                encType="multipart/form-data">
                <input name="profileImage" type="file" />
                <button type="submit">Upload</button>
            </form>
        </div>
    </body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        //common function
        var currentUser;
        var allChannel = [];

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        //Load chat list
        (function init(){
            $.ajax
            ({
                type: "GET",
                url: "/chat/getChat",
                dataType: 'json',
                async: false,
                headers: {
                    "authorization": "Bearer " + getCookie('chatJWT')
                },
                success:function(data) {
                    //insert user data
                    $('.phone').text(data.request.phone);
                    $('.email').text(data.request.email);
                    $('.userID').text(data.request.username + '#' + data.request.userID);
                    $('.icon').attr("src", '/imgDB/' + data.request.icon);
                    currentUser = data.request.username + '#' + data.request.userID;

                    //insert chatlist data
                    if(data.records.length > 0){
                        var html = '', datetime, datetimeFormat;
                        for(var i = 0; i < data.records.length; i++){                            
                            html += '<li data-id="'+data.records[i].chatID+'" id="chatroom'+data.records[i].chatID+'">' + 
                            'Chatroom name : ' + data.records[i]['chatroomName'] + '<br/>';
                                
                            //for socket
                            allChannel.push(data.records[i].chatID);
                           
                            if(data.records[i].conversations.length > 0){
                                let message, timestamp;
                                try{
                                    message = data.records[i].conversations[i]['message'];
                                    timestamp = data.records[i].conversations[i]['timestamp'];
                                }catch{
                                    message = '';
                                    timestamp = '';
                                }

                                html += '<span>' + message + ' ' + timestamp + '</span>';
                            }
                            
                            html += '</li>';
                        }
                        
                        $('#chatlist').append(html);
                    }
                }
            });

            var urlParams = new URLSearchParams(window.location.search);
            var uploadImg = urlParams.get('uploadImg');

            if(uploadImg){      
                var data = {
                    icon: uploadImg
                }    
                $.ajax
                ({
                    type: "POST",
                    url: "/users/changeIcon",
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    async: false,
                    data: JSON.stringify(data),
                    headers: {
                        "authorization": "Bearer " + getCookie('chatJWT')
                    },
                    success:function(data) {
                        $('.img').attr('src', '/imgDB/' + data.img);
                    },
                    error:function(data){
                        console.log(data);
                    }
                });

                history.pushState(null, '', '/chatlist.html');
            }
        })();

        //Create chat
        $('#createChat').submit(function(event){
            event.preventDefault();
            var data ={
                username:  $('#username').val(),
                chatroom: $('#chatroomName').val()
            }
            
            $.ajax
            ({
                type: "POST",
                url: "/chat/create",
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                async: false,
                data: JSON.stringify(data),
                headers: {
                    "authorization": "Bearer " + getCookie('chatJWT')
                },
                success:function(data) {
                    //insert chatlist data
                    var html='', datetime, datetimeFormat;
                    html += '<li data-id="'+data.records.chatID+'">' + 
                         'Chatroom name : ' + data.records['chatroomName'] + '</li>';
                    $('#chatlist').append(html);
                }
            });
        });

        $('#updateName').submit(function (event){
            event.preventDefault();
            var data = {
                username: $('#update-username').val(),
                password: $('#password').val(),
            }
            
            $.ajax
            ({
                type: "PATCH",
                url: "/users/update",
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                async: false,
                data: JSON.stringify(data),
                headers: {
                    "authorization": "Bearer " + getCookie('chatJWT')
                },
                error:function(data){
                    if(data.status === 400){
                        alert(data.responseJSON.message);
                    }else{
                        alert('Incorrect password');
                    }
                },
                success:function(data) {
                    window.location = '/chatlist.html';
                }
            });
        });

        $('#chatlist li').click(function(){
            window.location = '/chatroom.html?user='+ encodeURIComponent($('.userID').text()) +'&chatroom=' + $(this).attr('data-id');
        });

        const socket = io({query: {"username" : currentUser , 'chat' : allChannel, 'page' : 'chatlist'}}); 
        socket.on('chatroom list update', msg => {
            var roomName = msg.split('#')[0];
            var message = msg.split('#')[1];
            var timestamp = msg.split('#')[2];
            
            $('#chatroom'+roomName+' span').text(message +ã€€' ' + timestamp);
            $('#chatroom'+roomName).addClass('unread');
        });
    </script>
</html>