<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Chat - Chatlist</title>
        <style>
            /* Common */
            body { margin: 0; padding-bottom: 3rem; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
            * {font-family: Inter, sans-serif; margin: 0px;}
            body {background-color: white; margin: 0px;}    
            .clear {clear: both;}
            input { height: 35px; border-radius: 10px; border-color: #d2d2d7; }
            input:focus { outline: none; border-color: #1c98f7; box-shadow: 0 0 0 2px #1c98f7;}
            form p {margin: 20px 0px 2px 0px; font-size: 14px;}
            ul {padding: 0px; margin-right: 55px;}
            li {list-style: none;}

            /* Page */
            .pageContainer {max-width: 950px; margin: 0 auto;}
            .chatroom #form {max-width: 950px; margin: 0 auto;}
            .chatroomInfo { padding: 15px; border-bottom: 1px solid #EFEFEF}
            .chatroomInfo div {float: left;}
            .chatroomInfo::after {content: ''; display: table; clear: both;}
            .chatroomInfo .goBack {padding: 0px 15px 0px 0px; border-right: 1px solid black; cursor: pointer;}
            .chatroomInfo .goBack img{ height: 35px;}
            .chatroomInfo #icon {height: 35px; width: 35px; border-radius: 50%; float: right;}
            .chatroomInfo #header {font-size: 24px; text-align: center; width: calc(100% - 120px);}
            .chatroomInfo .chatroomName {width: calc(100% - 51px);}
            .chatroomInfo .chatroomName * {float: left; margin: 0 auto;}
            .chatroomInfo .chatroomName::after {content: ''; display: table; clear: both;}
            .chatroomInfo .moreOption {display: none;}

            /* Chatroom body */
            .chatroom {min-height: 80vh; background-image: url('/imgDB/55a44e59618507debb99d95fc16b659a.png');}

            /* Message */
            #messages .message { background: white; padding:20px; border-radius: 10px; display: inline-block; max-width: 42%;}
            #messages .messageImg {max-width: 100%;}
            #messages .messageImg img{max-height: 240px;}
            #messages li::after {clear: both; display: table; content: '';}
            #messages .message .content {word-break: break-word;}
            #messages .right {background: greenyellow; float: right;}

            /* Chat form */
            #form { background: rgba(0, 0, 0, 0.15); padding: 0.25rem; position: fixed; bottom: 0; left: 0; right: 0; display: flex; height: 3rem; box-sizing: border-box; backdrop-filter: blur(10px); }
            #input { border: none; padding: 0 1rem; flex-grow: 1; border-radius: 2rem; margin: 0.25rem; }
            #input:focus { outline: none; }
            #form > button { background: #333; border: none; padding: 0 1rem; margin: 0.25rem; border-radius: 3px; outline: none; color: #fff; }
      
            #messages { list-style-type: none; margin: 0; padding: 0; }
            #messages > li { padding: 0.5rem 1rem; }
        </style>
        <script>
            function allowDrop(ev) {
                ev.preventDefault();
            }

            function drop(ev) {
                ev.preventDefault();
                var data = ev.dataTransfer.files;
                $('.sendImageInput')[0].files = data;
                $('#sendImage button').trigger('click');
            }
        </script>
    </head>
    <body ondrop="drop(event)" ondragover="allowDrop(event)">
        <div class="pageContainer">
            <div class="chatroomInfo">
                <div class="goBack"><img src="/imgDB/back.svg" /></div>
                <div class="chatroomName"><img id="icon"/><span id="header"></span></div>
            
                <div class="moreOption">
                    <ul id="members"></ul>

                    <h3>Add member</h3>
                    <form action="" id="addMemberForm">
                        <p>Add your friend's' ID: e.g. john#315</p>
                        <input type="text" placeholder="john#315" pattern="[a-z0-9]+#[0-9]+" required id="username">
                        <button type="submit">Add</button>
                    </form>

                    <h3>Change chatroom name</h3>
                    <form action="" id="changeChatroom">
                        <input type="text" required id="chatroomName" minlength="1" maxlength="32">
                        <button type="submit">Change</button>
                    </form>

                    <h3>Change chatroom icon</h3>
                    <form id="fileUpload" 
                        action='/users/addImage' 
                        method='post' 
                        encType="multipart/form-data">
                        <input name="chatroomImage" type="file" />
                        <button type="submit">Upload</button>
                    </form>

                    <h3>Leave Chat</h3>
                    <form action="" id="leaveChat">
                        <button type="submit">Leave</button>
                    </form>  
                </div>    
            </div>

            <div class="chatroom"> 
                <ul id="messages"></ul>
                <form id="form" action="">
                    <input id="input" autocomplete="off" /><button>Send</button>
                </form>
            </div>

            <h3>Send image</h3>
            <form id="sendImage" 
                action='/users/addImage' 
                method='post' 
                encType="multipart/form-data">
                <input name="sendImage" class="sendImageInput" type="file" />
                <button type="submit">Send</button>
            </form>          
        </div>      
    </body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        function formatDate(date){
            if(date === '') return '';
            var d = new Date(date),
            month = '' + (d.getMonth() + 1),
            day = '' + d.getDate(),
            year = d.getFullYear();
            hour = d.getHours();
            minute = d.getMinutes();

            if (month.length < 2) 
                month = '0' + month;
            if (day.length < 2) 
                day = '0' + day;

            return [year, month, day].join('-') + ' ' + hour + ':' + minute;
        }

        (function init() {
            var urlParams = new URLSearchParams(window.location.search);
            var data = {
                currentChatID : urlParams.get('chatroom')
            }

            $.ajax
            ({
                type: "POST",
                url: "/chat/getConversation",
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                async: false,
                data: JSON.stringify(data),
                headers: {
                    "authorization": "Bearer " + getCookie('chatJWT')
                },
                error:function(data){
                },
                success:function(data) {
                    let chatroomName = data.content[0].chatroomName;
                    let content = data.content[0].conversations;
                    let members = data.content[0].members;
                    let icon = data.content[0].icon;
                    let html = '';
                    
                    $('#header').text(chatroomName);
                    $('#icon').attr('src', '/imgDB/' + icon);
                    if(content.length > 0){
                        for(var value of content){
                            var senderStyle = (urlParams.get('user').split('#')[1] === value.sender)? 'right' : 'left';

                            if( (/[a-z0-9].jpg|.png/).test(value.message) ){
                                html += '<li><div class="messageImg message  '+senderStyle+'">' +
                                    '<div class="sender">' + value.sender + '</div>' +
                                    '<div class="timestamp">' + formatDate(value.timestamp) + '</div>' +
                                    '<div class="img"><img src="/imgDB/'+value.message+'" alt="'+value.message+'" onError="$(this).hide(); $(this).parent().find(\'span\').show();"></div>' +
                                    '<div class="hiddenMsg"><span style="display:none">' +value.message+ '</span></div>' +
                                '</div></li>';
                            }else{
                                html += '<li><div class="message '+senderStyle+'">' +
                                    '<div class="sender">' + value.sender + '</div>' +
                                    '<div class="timestamp">' + formatDate(value.timestamp) + '</div>' + 
                                    '<div class="content">' + value.message + '</div>' +                                   
                                '</div></li>';
                            } 
                        }
                        $('#messages').append(html);
                    }

                    html = '';
                    for(var value of members){
                        html += '<li>' +
                            value +
                            '</li>';
                    }

                    $('#members').append(html);
                }
            });

            var urlParams = new URLSearchParams(window.location.search);
            var uploadImg = urlParams.get('uploadImg');
            var chatroom = urlParams.get('chatroom');
            var user= urlParams.get('user');

            if(uploadImg){      
                var data = {
                    currentChatID : urlParams.get('chatroom'),
                    icon: uploadImg
                }    

                $.ajax
                ({
                    type: "POST",
                    url: "/chat/changeIcon",
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    async: false,
                    data: JSON.stringify(data),
                    headers: {
                        "authorization": "Bearer " + getCookie('chatJWT')
                    },
                    success:function(data) {
                        $('#icon').attr('src', '/imgDB/' + data.icon);
                    },
                    error:function(data){
                        console.log(data);
                    }
                });

                history.pushState(null, '', '/chatroom.html?user=' + encodeURIComponent(user) + '&chatroom=' + chatroom);
            }
        })();

        $('.goBack').click(function(){
            window.location = '/chatlist.html';
        });

        var urlParams = new URLSearchParams(window.location.search);
        $('#addMemberForm').submit(function(event){
            event.preventDefault();
            var data ={
                username:  $('#username').val(),
                currentChatID : urlParams.get('chatroom')
            }
            
            $.ajax
            ({
                type: "POST",
                url: "/chat/addMember",
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                async: false,
                data: JSON.stringify(data),
                headers: {
                    "authorization": "Bearer " + getCookie('chatJWT')
                },
                error:function(data){
                    if(data.status === 404){
                        alert(data.responseJSON.message);
                    }
                },
                success:function(data) {
                    var html = '<li>' + data.member + '</li>';

                    $('#members').append(html);
                }
            });
        });

        $('#changeChatroom').submit(function(event) {
            event.preventDefault();

            var data ={
                chatroomName:  $('#chatroomName').val(),
                currentChatID : urlParams.get('chatroom')
            }

            $.ajax
            ({
                type: "PATCH",
                url: "/chat/changeChatName",
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                async: false,
                data: JSON.stringify(data),
                headers: {
                    "authorization": "Bearer " + getCookie('chatJWT')
                },
                error:function(data){
                    alert('failed');
                },
                success:function(data) {
                    $('#header').text($('#chatroomName').val());
                }
            });
        });

        $('#leaveChat').submit(function(event) {
            event.preventDefault();

            var data ={
                currentChatID : urlParams.get('chatroom')
            }

            $.ajax
            ({
                type: "PATCH",
                url: "/chat/leave",
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                async: false,
                data: JSON.stringify(data),
                headers: {
                    "authorization": "Bearer " + getCookie('chatJWT')
                },
                error:function(data){
                    alert('failed');
                },
                success:function(data) {
                    window.location = '/chatlist.html';
                }
            });
        });

        var currentUser = urlParams.get('user');
        const socket = io({query: {"username" : currentUser , 'chat' : urlParams.get('chatroom'), 'page' : 'chatroom'}}); 
        
        var form = document.getElementById('form');
        var input = document.getElementById('input');

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            if (input.value) {
                socket.emit('chat message', input.value);
                input.value = '';
            }
        });

        socket.on('receive', msg => {
            var message = msg.split('#')[0];
            var timestamp = msg.split('#')[1];
            var sender = msg.split('#')[2];
            var senderStyle = (urlParams.get('user').split('#')[1] === sender)? 'right' : 'left';

            if( (/[a-z0-9].jpg|.png/).test(msg) ){
                $('#message').append('<li><div class="message '+senderStyle+'">' +
                                    '<div class="sender">' + value.sender + '</div>' +
                                    '<div class="timestamp">' + formatDate(value.timestamp) + '</div>' +
                                    '<div class="img"><img src="/imgDB/'+value.message+'" alt="'+value.message+'" onError="$(this).hide(); $(this).parent().find(\'span\').show();"></div>' +
                                    '<div class="hiddenMsg"><span style="display:none">' +value.message+ '</span></div>' +
                                    '</div></li>');
            }else{
                $('#messages').append('<li><div class="message '+senderStyle+'">' +
                                    '<div class="sender">' + sender + '</div>' +
                                    '<div class="timestamp">' + timestamp + '</div>' + 
                                    '<div class="content">' + message + '</div>' +                                   
                                '</li>');
            }
            $("html, body").animate({ scrollTop: $(document).height() }, 1000);
        });

        var sendImg = urlParams.get('sendImage');
        var chatroom = urlParams.get('chatroom');
        
        if(sendImg){
            input.value = sendImg;

            $('#form button').trigger('click');
            history.pushState(null, '', '/chatroom.html?user=' + encodeURIComponent(currentUser) + '&chatroom=' + chatroom);
        }
    </script>
</html>