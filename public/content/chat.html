<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>TELECHAT - CHAT</title>
        <link href="/styles/main.css" rel="stylesheet" />
        <script src="/scripts/jquery.min.js"></script>
        <script src="/scripts/common_functions.js"></script>
        <script src="/socket.io/socket.io.js"></script>
    </head>
    <body class="chatPage">
        <main>
            <!-- More option div (hidden by default) -->
            <div id="optionContainer">
                <!-- Close button -->
                <div class="closeArrow"><i class="arrow arrow_up"></i></div>

                <div class="optionContainer__content profile">     
                    <div class="profile__title">
                        <h3>Profile</h3>
                    </div>  
                    <div class="profile__icon">
                        <img class="icon"/> 
                        <div class="overlay_icon">
                            <p>
                                Update Image
                                <span class="cameraImg"><svg viewBox="0 0 24 24" width="24" height="24" class=""><path fill="currentColor" d="M21.317 4.381H10.971L9.078 2.45c-.246-.251-.736-.457-1.089-.457H4.905c-.352 0-.837.211-1.078.468L1.201 5.272C.96 5.529.763 6.028.763 6.38v1.878l-.002.01v11.189a1.92 1.92 0 0 0 1.921 1.921h18.634a1.92 1.92 0 0 0 1.921-1.921V6.302a1.92 1.92 0 0 0-1.92-1.921zM12.076 18.51a5.577 5.577 0 1 1 0-11.154 5.577 5.577 0 0 1 0 11.154zm0-9.506a3.929 3.929 0 1 0 0 7.858 3.929 3.929 0 0 0 0-7.858z"></path></svg></span>
                            </p>
                        </div>
                    </div>
                    <div class="profile__username">
                        <h2>Your Name</h2>
                        <span class="username"></span>
                        <span id="initUpdateName"><svg viewBox="0 0 24 24" width="18" height="18" class=""><path fill="currentColor" d="M3.95 16.7v3.4h3.4l9.8-9.9-3.4-3.4-9.8 9.9zm15.8-9.1c.4-.4.4-.9 0-1.3l-2.1-2.1c-.4-.4-.9-.4-1.3 0l-1.6 1.6 3.4 3.4 1.6-1.6z"></path></svg></span>                    
                        <form id="updateName">
                            <input required type="text" maxlength="32" minlength="1" name="username" pattern="[a-zA-Z0-9]+" id="update-username" placeholder="New username"></input>
                            <p class="errMsg"></p>
                            <button type="submit" class="updateNameBtn"><svg viewBox="0 0 24 24" width="24" height="24" class=""><path fill="currentColor" d="M9 17.2l-4-4-1.4 1.3L9 19.9 20.4 8.5 19 7.1 9 17.2z"></path></svg></button>
                        </form>
                        <br/>
                        <span class="remarks">*This is not your username or pin. This name will be visible to your Telechat contacts.</span>
                    </div>
                    <form id="fileUpload" 
                        action='/users/addImage' 
                        method='post' 
                        encType="multipart/form-data"
                        onChange="submitProfileIcon()"
                        >
                        <input name="profileImage" id="profileImageBtn" type="file" />
                        <button type="submit" class="button">Upload</button>
                    </form>
                    <div class="profile__email">
                        <h2>Your Email</h2>
                        <span class="email"></span>
                    </div>
                    
                    <div class="logout">
                        <button class="logoutBtn">LOG OUT</button>
                    </div>
                </div>
            </div>

            <!-- Left part -->
            <div id="chatlist">
                <!-- show personal info -->
                <div class="chatlist__user">
                    <img class="icon"/>  
                    <span class="username"></span>
                    <span class="more"><svg viewBox="0 0 24 24" width="24" height="55"><path d="M12 7a2 2 0 1 0-.001-4.001A2 2 0 0 0 12 7zm0 2a2 2 0 1 0-.001 3.999A2 2 0 0 0 12 9zm0 6a2 2 0 1 0-.001 3.999A2 2 0 0 0 12 15z"></path></svg></span>                    
                </div>
            
                <!-- Create New Chat Section -->
                <div class="chatlist__newchat">
                    <h3 class="showCreateChat">Create New Chat <span class="createChatArrow"><i class="arrow arrow_down"></i></span></h3>

                    <!-- Add new chat form (hidden by default) -->
                    <div class="newchatForm">
                        <form id="createChat">
                            <p>Enter your friend username</p>
                            <input type="text" placeholder="e.g. john#315" pattern="[a-z0-9]+#[0-9]+" required id="username">
                            <p>Name the chatroom</p>
                            <input type="text" placeholder="chatroom name" required id="chatroomName" minlength="1" maxlength="32">
                            <p class="errorMsg"></p>
                            <button type="submit" class="createChatBtn">CREATE</button>
                        </form>
                    </div>
                </div>

                <!-- Show Joined Chatrooms -->
                <div class="chatlist__chatrooms">
                    <ul id="chatlist__chatrooms_list"></ul>
                </div>
            </div>

            <!-- Right part -->
            <div id="chatroom">
                <!-- Chatroom More Option (hidden by default) -->
                <div id="chatOptionContainer">
                    <div class="chatOptionContainer__content chatOp"> 
                        <span class="chatOp__close">X</span>
                        <div class="chatOp__title">
                            <h3>Chat Info</h3>
                        </div> 

                        <div class="chatOp__icon">
                            <img class="group_icon"/> 
                            <div class="overlay_icon" onclick="$('#chatIconUpdate').click();">
                                <p>
                                    Update Image
                                    <span class="cameraImg"><svg viewBox="0 0 24 24" width="24" height="24" class=""><path fill="currentColor" d="M21.317 4.381H10.971L9.078 2.45c-.246-.251-.736-.457-1.089-.457H4.905c-.352 0-.837.211-1.078.468L1.201 5.272C.96 5.529.763 6.028.763 6.38v1.878l-.002.01v11.189a1.92 1.92 0 0 0 1.921 1.921h18.634a1.92 1.92 0 0 0 1.921-1.921V6.302a1.92 1.92 0 0 0-1.92-1.921zM12.076 18.51a5.577 5.577 0 1 1 0-11.154 5.577 5.577 0 0 1 0 11.154zm0-9.506a3.929 3.929 0 1 0 0 7.858 3.929 3.929 0 0 0 0-7.858z"></path></svg></span>
                                </p>
                            </div>
                        </div>
                        <input type="file" id="chatIconUpdate" onchange="updateChatIcon()" style="display: none">
                        <div class="chatOp__chatname">
                            <h2>Chatroom Name</h2>
                            <span class="name"></span>
                            <span id="initUpdateChatName"><svg viewBox="0 0 24 24" width="18" height="18" class=""><path fill="currentColor" d="M3.95 16.7v3.4h3.4l9.8-9.9-3.4-3.4-9.8 9.9zm15.8-9.1c.4-.4.4-.9 0-1.3l-2.1-2.1c-.4-.4-.9-.4-1.3 0l-1.6 1.6 3.4 3.4 1.6-1.6z"></path></svg></span>                    
                            <form id="updateChatName">
                                <input required type="text" maxlength="32" minlength="1" name="chatname" pattern="[a-zA-Z0-9]+" id="update-chatname" placeholder="New chatroom"></input>
                                <p class="errMsg"></p>
                                <button type="submit" class="updateNameBtn"><svg viewBox="0 0 24 24" width="24" height="24" class=""><path fill="currentColor" d="M9 17.2l-4-4-1.4 1.3L9 19.9 20.4 8.5 19 7.1 9 17.2z"></path></svg></button>
                            </form>
                        </div>
                        <br/>
                        <div class="chatOp__members">
                            <h2>Chatroom Members</h2>
                            <ul class="members"></ul>
                        </div>
                        <br/>
                        <div class="chatOp__addMem">
                            <form id="addMem">
                                <p>Enter your friend username</p>
                                <input type="text" placeholder="e.g. john#315" pattern="[a-z0-9]+#[0-9]+" required id="memUsername">
                                <button type="submit" class="addMemBtn">ADD</button>
                            </form>
                            <p class="errMsg"></p>
                        </div>
                        <br/>
                        <div class="leaveroom">
                            <button class="leaveBtn">LEAVE</button>
                        </div>                       
                    </div>     
                </div>

                <!-- Chatroom information header -->
                <div class="chatroom_header">
                    <input type="file" id="theinput" onchange="sendImg()" style="display: none">
                    <div class="chatroomName">
                        <img id="chatroom_icon" src="/images/default.png"/>
                        <span id="chatName">&nbsp;</span>
                    </div>
                    <div class="chatroomMore">
                        <span class="more"><svg viewBox="0 0 24 24" width="24" height="55"><path d="M12 7a2 2 0 1 0-.001-4.001A2 2 0 0 0 12 7zm0 2a2 2 0 1 0-.001 3.999A2 2 0 0 0 12 9zm0 6a2 2 0 1 0-.001 3.999A2 2 0 0 0 12 15z"></path></svg></span>
                    </div>
                </div>

                <!-- Chatroom Body -->
                <div class="chatroom__content"> 
                    <div id="messages">
                        <div id="noMoreMsg">No More Previous Messages.</div>
                        <ul id="messages__read"></ul>
                        <div id="newMsgLine">New Messages.</div>
                        <ul id="messages__unread"></ul>

                        <!-- Quote Pannel -->
                        <div id="quotePanel">
                            <p>Reply:<span class="close">X</span></p>
                            
                            <div class="replyContent">
                                <p class="sender"></p>
                                <div class="message"><span></span><img src="#" style="display: none; height: 55px; width: 55px;" /></div>
                            </div>
                        </div>

                        <!-- Emoji Picker UI -->
                        <div id="emojiPicker" style="display:none">
                            <emoji-picker></emoji-picker>
                        </div>
                    </div>
                    <p id="showTyping">is typing</p>
                    <form id="form" class="chatroom__content__form" action="">
                        <input id="input" class="chatroom__content__input" autocomplete="off"/><button type="button" id="setDelBtn" onclick="setAutoDel();">Del Msg(5mins)</button><button type="button" onclick="$('#emojiPicker').toggle();">Emoji</button><button type="button" onclick="$('#theinput').click();">Image</button><button type="submit">Send</button>
                    </form>
                </div>
            </div>         
        </main>
    </body>
    <script>
        //Variables declaration
        var username;
        var userID;
        var allChannel = []; //used for connection IO socket
        var currentChatroom = '';
        var lastChatroom = '';
        var memberMap = {};
        var scrollLevel = document.getElementById('messages');
        var ScrollToHeight;
        var currentPage = 1; // 15 messages per page
        var loadReady = false; //true for intersection observer to set status
        var form = document.getElementById('form');
        var input = document.getElementById('input');
        var dropdownMenuHTMLRight = '<div class="dropdown"><button class="dropbtn">></button><div class="dropdown-content"><a class="msgRemoveBtn">Remove</a><a class="msgQuoteBtn">Quote</a></div></div>';
        var dropdownMenuHTMLLeft = '<div class="dropdown"><button class="dropbtn">></button><div class="dropdown-content"><a onclick="alert(\'Quote\')">Quote</a></div></div>';     
        var removeTarget = '';
        var timeoutDel = 0;
        $('#quotePanel .message').data('id', 'none');

        /**************** Functions *********************/
        function setAutoDel(){
            if(timeoutDel === 0){
                $('#setDelBtn').html('Disable auto del');
                timeoutDel = 5; //5mins
            }else{
                $('#setDelBtn').html('Del Msg(5mins)');
                timeoutDel = 0; //5mins
            }
        }

        function submitProfileIcon(){
            $('#fileUpload').trigger('submit');
        }

        function insertMessages(messages, pendFlow = 'pre'){
            var senderStyle = (userID.toString() === messages.sender)? 'right' : 'left';
            var dropdownHTML = (userID.toString() === messages.sender)? dropdownMenuHTMLRight : dropdownMenuHTMLLeft;
            var replyMsgHTML = '';

            if(messages.reply.isReply === 'true' || messages.reply.isReply === true){
                //if reply is an image
                if(messages.reply.isImage === 'true' || messages.reply.isImage === true){
                    replyMsgHTML = '<div class="replyMsg">Quote:<br/><div class="replySender">'+memberMap[messages.reply.senderID]+'</div><div class="replyContent" data-src="'+messages.reply.id+'"><img src="'+messages.reply.content+'" style="height: 35px; width: 35px;" /></div></div>';
                }else{
                    replyMsgHTML = '<div class="replyMsg">Quote:<br/><div class="replySender">'+memberMap[messages.reply.senderID]+'</div><div class="replyContent" data-src="'+messages.reply.id+'">'+messages.reply.content+'</div></div>';
                }
            }

            //Hide message
            if(messages.hideStatus){
                messages.content = '!This Message Has Been Removed!';
            }

            html = '';

            //Send Image
            if( (messages.isImage === true || messages.isImage === 'true') && !messages.hideStatus){
                html += '<li><div class="message  '+senderStyle+'">' +
                    dropdownHTML +
                    replyMsgHTML +
                    '<div class="sender">' + memberMap[messages.sender] + '#' + messages.sender + '</div>' +
                    '<div class="timestamp">' + formatDate(messages.timestamp) + '</div>' +
                    '<div class="img"><img src="/chatimages/'+messages.content+'" data-src="'+messages._id+'" onError="$(this).hide(); $(this).parent().find(\'span\').show();"></div>' +         
                '</div></li>';
            }
            //if text message
            else{
                html += '<li><div class="message '+senderStyle+'">' +
                    dropdownHTML +  
                    replyMsgHTML +
                    '<div class="sender">' + memberMap[messages.sender] + '#' + messages.sender + '</div>' +
                    '<div class="timestamp">' + formatDate(messages.timestamp) + '</div>' + 
                    '<div class="content" data-src="'+messages._id+'">' + messages.content + '</div>' +                                           
                '</div></li>';
            } 

            if(messages.read.indexOf(userID.toString()) >= 0){
                if(pendFlow === 'pre')
                    $('#messages__read').prepend(html);
                else{
                    $('#messages__read').append(html);
                }
            } 
            else{
                $('#newMsgLine').show();

                if(pendFlow === 'pre')
                    $('#messages__unread').prepend(html);
                else{
                    $('#messages__unread').append(html);
                }  
            }
        }
        
        //Send Image Function
        function sendImg() {
            var replyContent = getReply();

            const file = document.querySelector('#theinput[type=file]').files[0];
            const reader = new FileReader();

            reader.addEventListener("load", function () {
                var sendTimestamp = Date.now();
                chatroomSocket.emit('saveImage', {base64Img: reader.result, timestamp: sendTimestamp});
                chatroomSocket.emit('SendMSG', {msg: sendTimestamp+'.png', isImage: true, timeoutDel: timeoutDel, replyContent});
            }, false);

            if (file) {
                reader.readAsDataURL(file);
            }

            $('#quotePanel .close').trigger('click');
        }

        //Update Chatroom Icon
        function updateChatIcon() {
            const file = document.querySelector('#chatIconUpdate[type=file]').files[0];
            const reader = new FileReader();

            reader.addEventListener("load", function () {
                var sendTimestamp = Date.now();

                chatroomSocket.emit('saveImage', {base64Img: reader.result, timestamp: sendTimestamp});
                chatroomSocket.emit('ChatIconUpdated', {image: sendTimestamp+'.png', chatID: currentChatroom});

                //Ajax to update image path
                var data = {
                    currentChatID: currentChatroom,
                    imageName: sendTimestamp+'.png'
                }

                $.ajax
                ({
                    type: "PATCH",
                    url: "/chat/changeIcon",
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    async: false,
                    data: JSON.stringify(data),
                    headers: {
                        "authorization": "Bearer " + getCookie('chatJWT')
                    },
                    //if conversation/chatroom not found
                    error:function(data){
                    },
                    success:function(data) {
                        //Change socket IO chatroom ID
                        chatroomSocket.emit('UpdateChatroomName', {newRoomName: $('#update-chatname').val(), chatID: currentChatroom});
                    }
                }); 
            }, false);

            if (file) {
                reader.readAsDataURL(file);
            }   
        }

        //Get reply Content
        function getReply() {
            var replyContent = { 
                isReply: false,
                isImage: false,
                content: '',
                senderID: '',
                id: ''
            };

            //check if there is reply data
            if( $('#quotePanel .message').data('id') !== 'none'){
                replyContent.isReply = true;

                //check if it is a image
                replyContent.isImage = $('#quotePanel .message img').attr('src') !== '#'? true : false;

                //prepare reply content
                if(replyContent.isImage){
                    replyContent.content = $('#quotePanel .message img').attr('src');
                }else{
                    replyContent.content = $('#quotePanel .message span').html();
                }

                //prepare sender id
                replyContent.senderID = $('#quotePanel .sender').html().split('#')[1];

                //prepare message id
                replyContent.id = $('#quotePanel .message').data('id');
            }
            return replyContent;
        }

        //call this when join new chatroom
        function joinChat() {
            //Prepare data to init the chatroom
            var data = {
                currentChatID: currentChatroom
            }

            /* get the conversation in that chatroom */
            $.ajax
            ({
                type: "POST",
                url: "/chat/initChatroom",
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                async: false,
                data: JSON.stringify(data),
                headers: {
                    "authorization": "Bearer " + getCookie('chatJWT')
                },
                //if conversation/chatroom not found
                error:function(data){
                },
                success:function(data) {
                    var chatroomName = data.content.chatroomName;
                    var members = data.content.members;
                    var icon = data.content.icon;
                    var content = [];
                    var html = '';
                    
                    $('.chatOp__members .members').html(''); //reset member list
                    for(var [key, value] of data.members.entries()){
                        memberMap[value.userID] = value.username;

                        //Insert memberlist into chat info
                        $('.chatOp__members .members').append('<li>' + value.username + '#' + value.userID  + ' <span id="onlineStatus-'+value.userID+'">'+ formatDateChatList(value.lastSeen) +'</span></li>');
                    }

                    $('#chatName').text(chatroomName);
                    $('#chatroom_icon').attr('src', '../chatimages/' + icon);
                    $('.group_icon').attr('src', '../chatimages/' + icon);
                    $('.chatOp__chatname .name').text(chatroomName);

                    //Hide typing 
                    $('#showTyping').html('is typing');
                    $('#showTyping').hide();
                    
                    if(data.content.unreadMsg.length > 0 || data.content.readMsg.length > 0){
                        var unreadMsg = data.content.unreadMsg;
                        var readMsg = data.content.readMsg;

                        //push all the read & unread msg into content array
                        for(var [key, value] of unreadMsg.entries()){
                            content.push(value);
                        }
                        for(var [key, value] of readMsg.entries()){
                            content.push(value);
                        }

                        //Prepend all loaded messages
                        for(var value of content){
                            insertMessages(value);
                        }     
                    }
                }
            });

            //Set Client Scroll bar at bottom of read messages;
            ScrollToHeight = document.getElementById('messages__unread');
            scrollLevel.scrollTop = ScrollToHeight.offsetheight;
        }

        /**************** Event listeners ***************/
        $('.chatlist__user .more').on('click', function(){
            $('#optionContainer').removeClass('closeFromBottom');
            $('#optionContainer').addClass('enterFromTop');
        });

        $('#optionContainer .closeArrow').on('click', function() {
            $('#optionContainer').removeClass('enterFromTop');
            $('#optionContainer').addClass('closeFromBottom');
        });

        //Click log-out button to logout (set cookie to expire)
        $('.logoutBtn').on('click', function(){
            document.cookie = "chatJWT=; path=/; expires = Thu, 01 Jan 1970 00:00:00 GMT"
            window.location = '/content/login.html';
        });

        //Close Quote Panel
        $('#quotePanel .close').on('click', function() {
            $('#quotePanel').hide();
            $('#quotePanel .message').data('id', 'none');
            $('#quotePanel .sender').html('');
            $('#quotePanel .message span').html('');
            $('#quotePanel img').attr('src', '#');
        });

        //Click to show create chat form
        $('.showCreateChat').on('click', function(){
            $('#createChat').toggle();
            if($('#createChat').hasClass('expendFromTop')){
                $('#createChat').removeClass('expendFromTop');
                $('#createChat').addClass('shrinkFromBottom');

                $('.createChatArrow .arrow').css('transform', 'rotate(45deg)');      
                $('.createChatArrow').css('margin-top', '-2px');
            }else{
                $('#createChat').removeClass('shrinkFromBottom');
                $('#createChat').addClass('expendFromTop');    
     
                $('.createChatArrow .arrow').css('transform', 'rotate(225deg)');
                $('.createChatArrow').css('margin-top', '2px');
            }
        });

        //Click to show update username form
        $('#initUpdateName').on('click', function() {
            $('#updateName').toggle();
            $('#update-username').focus();
        });

        //Click to show update group form
        $('#initUpdateChatName').on('click', function() {
            $('#updateChatName').toggle();
            $('#update-chatname').focus();
        });

        //Update Chatroom name
        $('#updateChatName').submit(function(e){
            e.preventDefault();

            var data = {
                currentChatID: currentChatroom,
                chatroomName: $('#update-chatname').val()
            }

            $.ajax
            ({
                type: "PATCH",
                url: "/chat/changeChatName",
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                async: false,
                data: JSON.stringify(data),
                headers: {
                    "authorization": "Bearer " + getCookie('chatJWT')
                },
                //if conversation/chatroom not found
                error:function(data){
                },
                success:function(data) {
                    //Change socket IO chatroom ID
                    chatroomSocket.emit('UpdateChatroomName', {newRoomName: $('#update-chatname').val(), chatID: currentChatroom});
                }
            });   
        })

        //Click to Update Profile Image
        $('.optionContainer__content .overlay_icon').on('click', function() {
            $('#profileImageBtn').trigger('click');          
        });

        //Click to Change Chatroom
        $('#chatlist__chatrooms_list').delegate('.chatroom', 'click', function() {
            if( $(this).data('id') !== currentChatroom ){
                // Clear Chatroom messages
                $('#messages__read').html('');
                $('#messages__unread').html('');

                $('#noMoreMsg').hide();
                $('#newMsgLine').hide();

                lastChatroom = currentChatroom;
                currentChatroom = $(this).data('id');
                
                //Change Highlighted chatroom
                $('#chatroom'+lastChatroom).removeClass('activeChat');
                $('#chatroom'+currentChatroom).addClass('activeChat');

                //Change socket IO chatroom ID
                chatroomSocket.emit('ChangeRoom', {newRoom: currentChatroom, oldRoom: lastChatroom});

                //Join Clicked Chatroom
                joinChat();

                //Get all online users
                chatroomSocket.emit('GetOnlineUsers', {userID: userID});

                //Reset current page
                currentPage = 1;
            }
        });

        //Show chat info overlay
        $('.chatroomMore').on('click', function(){
            $('#chatOptionContainer').show();
        });

        //Close chat info overlay
        $('.chatOp__close').on('click', function(){
            $('#chatOptionContainer').hide();
        });

        //Listen when user scroll to messages top then load more history messages
        $('#messages').scroll(function() {
            if(scrollLevel.scrollTop === 0) {
                //Load more messages
                if(currentPage !== -1){
                    var data = {
                        currentChatID: currentChatroom,
                        page: currentPage
                    }

                    $.ajax
                    ({
                        type: "POST",
                        url: "/chat/loadMessages",
                        contentType: 'application/json; charset=utf-8',
                        dataType: 'json',
                        async: false,
                        data: JSON.stringify(data),
                        headers: {
                            "authorization": "Bearer " + getCookie('chatJWT')
                        },
                        //if conversation/chatroom not found
                        error:function(data){
                        },
                        success:function(data) {
                            //No More History data available
                            var messages = [];
                            if(data.content.length === 0){
                                currentPage = -1;

                                //show message to show there is no more history message for users
                                $('#noMoreMsg').show();
                            } 

                            //If there has more history messages to prepend
                            if(currentPage !== - 1){
                                //Reverse the data in messages array to display
                                for(var [key, value] of data.content.entries()){
                                    messages.push(value.messages)
                                }

                                //Prepend loaded messages
                                for(var value of messages){
                                    insertMessages(value);
                                } 

                                //Fix the position of the scroll Bar 
                                scrollLevel.scrollTop = 30;
                                currentPage++;
                            }         
                        }
                    });      
                }        
            }
        });
        
        //Remove Message BTN 
        $('#messages').delegate('.msgRemoveBtn', 'click', function (){
            if($(this).parents('.message').find('.sender').html().split('#')[1] === userID.toString()){
                
                if($(this).parents('.message').find('.content').data('src') !== undefined)
                    removeTarget = $(this).parents('.message').find('.content').data('src');
                else
                    removeTarget = $(this).parents('.message').find('img').data('src');

                //Perform remove hide = true
                //prepare data
                var data = {
                    currentChatID: currentChatroom,
                    msgID: removeTarget
                }

                $.ajax
                ({
                    type: "PATCH",
                    url: "/chat/removeMsg",
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    async: false,
                    data: JSON.stringify(data),
                    headers: {
                        "authorization": "Bearer " + getCookie('chatJWT')
                    },
                    //if conversation/chatroom not found
                    error:function(err){
                    },
                    success:function(data) {
                        //Remove MSG from Sender View
                        $('*[data-src="'+data.msgID+'"]').html('!This Message Has Been Removed!');

                        //Send Alert to Remove other users' view
                        chatroomSocket.emit('MSGRemoved', {chatID: currentChatroom, msgID: data.msgID});
                    }
                }); 
            }
        });

        
        //On click Quote message
        $('#messages').delegate('.msgQuoteBtn', 'click', function (){
            var replyMessage = $(this).parents('.message').find('.content').html();
            var replyMessageID = $(this).parents('.message').find('.content').data('src');

            var replyImage = $(this).parents('.message').find('img').attr('src');
            var replyImageID = $(this).parents('.message').find('img').data('src');

            var replySender =  $(this).parents('.message').find('.sender').html();

            //If this is a text message
            if(replyMessage || replyMessageID){
                //make sure not to include image src in quote
                //hide data
                $('#quotePanel img').attr('src', '#');
                $('#quotePanel img').hide();

                //prepare data
                $('#quotePanel .message span').html(replyMessage);
                //prepare id for quote message
                $('#quotePanel .message').data('id', replyMessageID);
            //if this is a image message
            }else{
                //hide data
                $('#quotePanel .message span').html('');

                //prepare data
                $('#quotePanel img').attr('src', replyImage);
                $('#quotePanel img').show();

                 //prepare id for quote message
                 $('#quotePanel .message').data('id', replyImageID);
            }
            //insert sender's name
            $('#quotePanel .sender').html(replySender);
            
            $('#quotePanel').show();
        });

        //Click to leave Chatroom
        $('.leaveBtn').on('click', function(){
            //prepare data
            var data = {
                currentChatID: currentChatroom
            }

            $.ajax
            ({
                type: "PATCH",
                url: "/chat/leave",
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                async: false,
                data: JSON.stringify(data),
                headers: {
                    "authorization": "Bearer " + getCookie('chatJWT')
                },
                //if conversation/chatroom not found
                error:function(err){
                },
                success:function(data) {
                    //remove chatlist li
                    $('#chatroom'+ currentChatroom).remove();

                    //leave chatlist & chatroom socket
                    chatroomSocket.emit('LeaveRoom', currentChatroom);
                }
            }); 
        });

        //Submit form to add new member
        $('#addMem').submit(function(e){
            //prevent pagereload
            e.preventDefault();

            //prepare data
            var data = {
                currentChatID: currentChatroom,
                username: $('#memUsername').val()
            }

            $.ajax
            ({
                type: "POST",
                url: "/chat/addMember",
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                async: false,
                data: JSON.stringify(data),
                headers: {
                    "authorization": "Bearer " + getCookie('chatJWT')
                },
                //if conversation/chatroom not found
                error:function(err){
                    //handle error  
                    $('.chatOp__addMem .errMsg').show();
                    if(err.responseJSON.error.statusCode === 401){
                        $('.chatOp__addMem .errMsg').html('*Cannot add yourself.');          
                    }else if(err.responseJSON.error.statusCode === 404){
                        $('.chatOp__addMem .errMsg').html('*Target user not found.');          
                    }else if(err.responseJSON.error.statusCode === 402){
                        $('.chatOp__addMem .errMsg').html('*Target already in the chat.');         
                    }
                },
                success:function(data) {
                    //insert the new member in members list
                    $('.chatOp__members .members').append('<li>' + data.member  + '<span id="onlineStatus-'+ data.member.split('#')[1] +'"></span></li>');
                    
                    //Alert the new member
                    chatroomSocket.emit('AddedMember', {memID : data.member.split('#')[1], chatInfo : data.chatroomInfo});
                }
            });   
        });

        //Emoji picker listener
        document.querySelector('emoji-picker').addEventListener('emoji-click', event => {  
            $('#input').val( $('#input').val() + event.detail.unicode);
        });

        //Intersection observer to update read status
        var observerTarget = document.getElementById('messages__unread');
        const obsCallback = function() {
            var isScrollable = $('#messages').height() - $('#noMoreMsg').height() - $('#messages__read').height() - $('#newMsgLine').height();
            var data = {
                currentChatID: currentChatroom
            }

            if((loadReady === true && $('#messages__unread').height() > 0 || isScrollable > 0) && currentChatroom !== ''){
                //Update user read status by inserting userID into the chat.read array
                $.ajax
                ({
                    type: "PATCH",
                    url: "/chat/updateRead",
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    async: false,
                    data: JSON.stringify(data),
                    headers: {
                        "authorization": "Bearer " + getCookie('chatJWT')
                    },
                    success:function(data) {
                        //Push unread messages into read messages
                        $('#messages__read').append($('#messages__unread').html());

                        //Hide new message line
                        $('#messages__unread').html('');
                        $('#newMsgLine').hide();

                        //Remove chatroom border right
                        $('#chatroom'+currentChatroom).css('border-right', 'none');
                    },
                    error:function(data){
                    }
                });
            }

            //When page load it will trigger this callback function, this can avoid updating read status when page load
            if($('#messages__unread').height() > 0)
                loadReady = true;           
        };

        const observer = new IntersectionObserver(obsCallback, {
            //options
            root: null,
            threshold: 0.1 //need more than 10% to be 'Intersecting'
        });
        observer.observe(observerTarget);

        /************ Initial page function, load all the chatroom detail for the user ***********/
        (function init(){
            $.ajax
            ({
                type: "GET",
                url: "/chat/init",
                dataType: 'json',
                async: false,
                //get the token from cookie and send to server in request's header
                headers: {
                    "authorization": "Bearer " + getCookie('chatJWT')
                },
                success:function(data) {
                    //Display user information from server
                    $('.username').text(data.user.username + '#' + data.user.userID);
                    $('.icon').attr("src", '/images/' + data.user.icon);
                    $('.email').text(data.user.email);
                    
                    username = data.user.username;
                    userID = data.user.userID;

                    //Sort the chatroom by time, the chatroom with latest message on top              
                    data.records.sort( (a, b) => {
                        let timeA, timeB;
                        timeA = (a.messages[0])? new Date(a.messages[0].timestamp) : new Date(a.chatCreate);
                        timeB = (b.messages[0])? new Date(b.messages[0].timestamp) : new Date(b.chatCreate);

                        return timeB - timeA;                 
                    });
                    
                    //Display the chatlist details
                    if(data.records.length > 0){
                        var html = '', datetime, datetimeFormat, lastData, styleClass;
                        for(var i = 0; i < data.records.length; i++){          
                            styleClass = (i === 0)? 'activeChat' : '';
                            html += '<li data-id="'+data.records[i].chatID+'" class="chatroom '+styleClass+'" id="chatroom'+data.records[i].chatID+'">' + 
                                        '<div class="left"><img src="/chatimages/'+ data.records[i]['icon'] +'" class="chatroom_icon" /></div>' +
                                        '<div class="right"><span class="roomName">' + data.records[i]['chatroomName'] + '</span><br/>';
                                                 
                            //Join chatroom to listen if any message are send to this user
                            currentChatroom = (currentChatroom === '')? data.records[i].chatID : currentChatroom;
                            allChannel.push(data.records[i].chatID);
                            
                            if(data.records[i].messages.length > 0){                                
                                let message, timestamp, isImage;

                                isImage = (!data.records[i].messages[0].hasOwnProperty('isImage'))? '' : data.records[i].messages[0]['isImage'];
                                message = (!data.records[i].messages[0].hasOwnProperty('content'))? '' : data.records[i].messages[0]['content'];
                                message = (isImage)? 'Image' : message;

                                timestamp = (!data.records[i].messages[0].hasOwnProperty('timestamp'))? data.records[i].chatCreate : data.records[i].messages[0]['timestamp'];
                                html += '<span class="message">' + message + '</span><span class="timestamp">' + formatDateChatList(timestamp) + '</span></div>';
                            }
                          
                            html += '</li>';
                        }

                        $('#chatlist__chatrooms_list').append(html);
                    }
                }
            });

            //Join The Default Chatroom (top on the list)
            if(currentChatroom !== ''){
               joinChat();
            }

            //get all the params
            var urlParams = new URLSearchParams(window.location.search);
            /*
            When upload an image,
            server side will first create a copy in /contnet/images,
            if success, server will send a uploadImg param with image name value to user,
            then user will use this info to make the below request
            */
            var uploadImg = urlParams.get('uploadImg');

            //if successfully create a copy in db
            if(uploadImg){      
                //prepare data
                var data = {
                    icon: uploadImg
                }    
                $.ajax
                ({
                    type: "PATCH",
                    url: "/users/changeUserIcon",
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    async: false,
                    data: JSON.stringify(data),
                    headers: {
                        "authorization": "Bearer " + getCookie('chatJWT')
                    },
                    success:function(data) {
                        //if image update success, change the icon
                        $('.icon').attr('src', '/images/' + data.img);
                    },
                    error:function(data){
                    }
                });

                //hide the params
                history.pushState(null, '', '/content/chat.html');
            }
        })();

        /* Create Chatroom */
        $('#createChat').submit(function(event){
            //prevent reload
            event.preventDefault();

            //prepare data
            var data ={
                username:  $('#username').val(),
                chatroom: $('#chatroomName').val()
            }
            
            $.ajax
            ({
                type: "POST",
                url: "/chat/create",
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                async: false,
                data: JSON.stringify(data),
                headers: {
                    "authorization": "Bearer " + getCookie('chatJWT')
                },
                success:function(data) {
                    //insert chatlist data
                    var html='', datetime, datetimeFormat;

                    html += '<li data-id="'+data.records.chatID+'" class="chatroom" id="chatroom'+data.records.chatID+'">' + 
                                '<div class="left"><img src="/chatimages/'+ data.records.icon +'" class="chatroom_icon" /></div>' +
                                '<div class="right"><span class="roomName">' + data.records.chatroomName + '</span><br><span class="message"></span><span class="timestamp"></span>';
                    html += '</li>';       

                    //Join chatroom to listen if any message are send to this user
                    allChannel.push(data.records.chatID);
                    
                    //Emit message to add chatlist
                    //Join member socket room
                    chatroomSocket.emit('CreatedNewChat', data);

                    $('#chatlist__chatrooms_list').prepend(html);
                },
                error:function(err){
                    //handle mongoDB duplicated error       
                    if(err.responseJSON.error.statusCode === 401){
                        $('#createChat .errorMsg').html('*Cannot create a chatroom yourself.');          
                    }else if(err.responseJSON.error.statusCode === 404){
                        $('#createChat .errorMsg').html('*Target user not found.');          
                    }
                }
            });
        });

        /* Update personal information */
        $('#updateName').submit(function (event){
            //prevent reload
            event.preventDefault();

            //prepare data
            var data = {
                username: $('#update-username').val()
            }
            
            $.ajax
            ({
                type: "PATCH",
                url: "/users/updateUserName",
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                async: false,
                data: JSON.stringify(data),
                headers: {
                    "authorization": "Bearer " + getCookie('chatJWT')
                },
                error:function(data){
                    if(data.status === 404){
                        $('#updateName .errMsg').html('Update Failed');
                    }
                },
                success:function(data) {
                    $('.profile__username .username').html($('#update-username').val() + '#' + userID);

                    //update username
                    username = $('#update-username').val();

                    //update membermapping after update name
                    memberMap[userID] = $('#update-username').val();

                    //socket alert other member to update its member map
                    chatroomSocket.emit('UpdateMemberMap', {chatID: currentChatroom, username: username, userID: userID});
                    $('#update-username').val('');      
                }
            });
        });

        /* Socket IO Related */
        //Join Chatroom socket
        const chatroomSocket = io({query: {"userID" : userID, 'username': username, 'chatID': currentChatroom, 'chatlist': allChannel} }); 

        //Get all online users
        chatroomSocket.emit('GetOnlineUsers', {userID: userID});

        var form = document.querySelector('.chatroom__content__form');
        var input = document.querySelector('.chatroom__content__input');

        //when user send message
        form.addEventListener('submit', function(e) {
            var replyContent = getReply();

            e.preventDefault();
            if (input.value) {
                chatroomSocket.emit('SendMSG', {msg: input.value, isImage: false, timeoutDel: timeoutDel, replyContent});
                input.value = '';
            }

            //close quote panel
            $('#quotePanel .close').trigger('click');
        });

        //when user receive message
        chatroomSocket.on('Receive', msg => {
            var message = msg.split('#')[0];
            var timestamp = msg.split('#')[1];
            var sender = msg.split('#')[2];
            var messageID = msg.split('#')[3];
            var isImage = msg.split('#')[4];
            var senderStyle = (userID.toString() === sender)? 'right' : 'left';     
            var replyContent = {
                isReply: msg.split('#')[5],
                content: msg.split('#')[6],
                id: msg.split('#')[7],
                senderID: msg.split('#')[8],
                isImage: msg.split('#')[9]
            }

            var data = {
                sender: sender,
                timestamp: timestamp,
                content: message,
                read: [userID],
                isImage: isImage,
                reply: replyContent,
                _id: messageID
            }

            //display message
            insertMessages(data, 'append');
            
            //scroll to bottom
            $('#messages').animate({ scrollTop: $('#messages__unread').height() + $('#messages__read').height() }, 1000);
        });

        //Update Chaticon
        chatroomSocket.on('UpdateChatIcon', msg => {
            //update chatroom image
            if(msg.chatID === currentChatroom){
                document.getElementById('chatroom_icon').src = '/chatimages/'+msg.image;
                document.querySelector('.group_icon').src = '/chatimages/'+msg.image;
            }

            //update chatlist image
            document.querySelector('#chatroom'+msg.chatID + ' img').src = '/chatimages/'+msg.image;
        });

        /* Show typing listener */
        //Show which username typing
        var typeTimer;                //timer identifier
        var doneTypingInterval = 3000;  //time in ms, 5 second for example
        var timerInput = $('#input');
        var usertyping = [];

        //on keyup, start the countdown
        timerInput.on('keyup', function () {
            clearTimeout(typeTimer);
            typeTimer = setTimeout(doneTyping, doneTypingInterval);
        });

        //on keydown, clear the countdown 
        timerInput.on('keydown', function () {
            chatroomSocket.emit('UserTyping', {userID: userID, chatID: currentChatroom});
            clearTimeout(typeTimer);
        });

        //Typing is ended
        function doneTyping () {
            chatroomSocket.emit('UserDoneTyping', {userID: userID, chatID: currentChatroom});
        }

        //show who is typing
        chatroomSocket.on('ShowUserTyping', msg => {
            if(usertyping.indexOf(msg) < 0 ){
                usertyping.push(msg);

                //show typing msg
                if($('#showTyping').html().indexOf(memberMap[msg]+'#'+msg) < 0)
                    $('#showTyping').html( ' ' + memberMap[msg]+'#'+msg + ' ' + $('#showTyping').html());
                $('#showTyping').show();
            }
        });

        //remove user tpying name
        chatroomSocket.on('AlertUserDoneTyping', msg => {
            if(usertyping.indexOf(msg) >= 0 ){
                usertyping = usertyping.filter( curVal => {
                    return curVal !== msg;
                })

                //show typing msg
                if(usertyping.length > 0 ){
                    $('#showTyping').html().replace( memberMap[msg]+'#'+msg, '');
                }else{
                    $('#showTyping').html('is typing');
                    $('#showTyping').hide();
                }
            }
        });

        //Remove Msg
        chatroomSocket.on('AlertMSGRemoved', data => {
            //Remove text
            $('*[data-src="'+data.msgID+'"]').html('!This Message Has Been Removed!');

            //Remove Image
            if($('*[data-src="'+data.msgID+'"]').parent().hasClass('img'))
                $('*[data-src="'+data.msgID+'"]').parent().html('<div class="content">!This Message Has Been Removed!</div>')
        });

        //When other member created a chatroom and added u
        chatroomSocket.on('SomeoneCreatedAChatWithYou', data => {
            //Prepend the new chatroom in the chatlist
            var html='', datetime, datetimeFormat;

            html += '<li data-id="'+data.records.chatID+'" class="chatroom" id="chatroom'+data.records.chatID+'">' + 
                        '<div class="left"><img src="/images/'+ data.records.icon +'" class="chatroom_icon" /></div>' +
                        '<div class="right"><span class="roomName">' + data.records.chatroomName + '</span><br><span class="message">*New Chatroom*</span><span class="timestamp"></span>';
            html += '</li>';       

            //Join chatroom to listen if any message are send to this user
            allChannel.push(data.records.chatID);

            //Join chatlist room
            chatroomSocket.emit('JoinChatlistRoom', data.records.chatID);

            $('#chatlist__chatrooms_list').prepend(html);
        });

        //Update chatroom name
        chatroomSocket.on('ChatroomNameUpdated', data => {
            $('#chatroom'+data.chatID + ' .roomName').html(data.newName);

            if(currentChatroom == data.chatID)
                $('#chatName').html(data.newName);
        });

        //Update member map
        chatroomSocket.on('AlertUpdateMemberMap', data => {
            memberMap[data.userID] = data.username;
        });

        //socket listen to the chatroom that has message sent out
        chatroomSocket.on('ChatlistUpdate', msg => {
            var message = msg.split('#')[0];
            var timestamp = msg.split('#')[1];
            var roomID = msg.split('#')[2];
            var senderUserID = parseInt(msg.split('#')[3]);
            var isImage = msg.split('#')[4];
            message = (isImage === 'true')? 'image' : message;

            $('#chatroom'+roomID+' .message').text(message);
            $('#chatroom'+roomID+' .timestamp').text( formatDateChatList(timestamp) );
            if(userID !== senderUserID){
                $('#chatroom'+roomID).css('border-right', '5px solid #183a55');
            }

            //move the chat to the top
            var originalItem = $('#chatroom'+roomID);
            $('#chatroom'+roomID).remove();
            $('#chatlist__chatrooms_list').prepend(originalItem);
        });

        //Receive array to show online users
        chatroomSocket.on('ReceiveOnlineMember', data => {
            for(let userID of data){
                $('#onlineStatus-'+userID).html('online');
            }
        });

        //Update user lastSeen if they went offline
        chatroomSocket.on('MemberOffline', data => {
            $('#onlineStatus-'+data.userID).html( formatDateChatList(data.lastSeen) );
        });

        //Update user lastSeen if they went online
        chatroomSocket.on('MemberOnline', data => {
            $('#onlineStatus-'+data.userID).html('online');
        });    
    </script>
    <!-- EMOJI picker package -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
</html>