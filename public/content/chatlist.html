<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Chat - Chatrooms list</title>
        <link rel="stylesheet" src="/content/styles/main.css" />
    </head>
    <body class="chatlistPage">
        <div class="chatlistPage__main">
            <!-- show personal info -->
            <div class="chatlistPage__userInfo">
                <img class="icon"/>  
                <span class="userID"></span>
                <div class="logout">Log Out</div>
                <div class="moreBtn">more</div>

                <div class="moreInfo">
                    <p class="email"></p>
                    <p class="phone"></p>
                    
                    <h3>Update Personal info</h3>
                    <form id="fileUpload" 
                        action='/users/addImage' 
                        method='post' 
                        encType="multipart/form-data">
                        <input name="profileImage" type="file" />
                        <button type="submit" class="button">Upload</button>
                    </form>

                    <!-- Update personal info -->
                    <h3>Update username</h3>
                    <form id="updateName">
                        <p>Username:</p>
                        <input required type="text" maxlength="32" minlength="1" name="username" pattern="[a-z0-9]+" id="update-username" placeholder="Enter username"></input>
                        <p>Password:</p>
                        <input required type="password" name="password" minlength="6" maxlength="16" id="password" placeholder="Enter password">
                        <button type="submit" class="button">confirm</button>
                    </form>
                </div>
            </div>

            <!-- create chatroom -->
            <p class="createChatBtn">New Chat</p>
            <div class="chatlistPage__createChat">
                <form id="createChat">
                    <p>Add your friend's' ID: e.g. john#315</p>
                    <input type="text" placeholder="john#315" pattern="[a-z0-9]+#[0-9]+" required id="username">
                    <input type="text" placeholder="chatroom name" required id="chatroomName" minlength="1" maxlength="32">
                    <button type="submit" class="button">create</button>
                </form>
                <div class="errorMsg"></div>
            </div>

            <!-- Chatroom list -->
            <ul id="chatlist"></ul>
        </div>
    </body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        //common function
        var currentUser;
        var allChannel = [];

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        function formatDate(date){
            if(date === '') return '';
            var d = new Date(date),
            month = '' + (d.getMonth() + 1),
            day = '' + d.getDate(),
            year = d.getFullYear();
            hour = d.getHours();
            minute = d.getMinutes();

            if (month.length < 2) 
                month = '0' + month;
            if (day.length < 2) 
                day = '0' + day;

            return [year, month, day].join('-') + ' ' + hour + ':' + minute;
        }

        //Load chat list
        (function init(){
            $.ajax
            ({
                type: "GET",
                url: "/chat/getChatList",
                dataType: 'json',
                async: false,
                headers: {
                    "authorization": "Bearer " + getCookie('chatJWT')
                },
                success:function(data) {
                    //insert user data
                    $('.phone').text( 'Phone: ' + data.request.phone);
                    $('.email').text( 'Email: ' + data.request.email);
                    $('.userID').text(data.request.username + '#' + data.request.userID);
                    $('.icon').attr("src", '/content/images/' + data.request.icon);
                    currentUser = data.request.username + '#' + data.request.userID;

                    data.records.sort( (a, b) => {
                        let timeA, timeB;
                        timeA = (a.conversations[0])? new Date(a.conversations[0].timestamp) : new Date(a.chatCreate);
                        timeB = (b.conversations[0])? new Date(b.conversations[0].timestamp) : new Date(b.chatCreate);

                        return timeB - timeA;                 
                    });   

                    //insert chatlist data
                    if(data.records.length > 0){
                        var html = '', datetime, datetimeFormat;
                        for(var i = 0; i < data.records.length; i++){                            
                            html += '<li data-id="'+data.records[i].chatID+'" class="chatroom" id="chatroom'+data.records[i].chatID+'">' + 
                                    '<div class="left"><span></span><img src="/content/images/'+ data.records[i]['icon'] +'" class="icon" /></div>' +
                                    '<div class="right"><span class="roomName">' + data.records[i]['chatroomName'] + '</span><br/>';
                                                                    
                            //for socket
                            allChannel.push(data.records[i].chatID);
                            if(data.records[i].conversations.length > 0){
                                
                                let message, timestamp;
                                message = (!data.records[i].conversations[0].hasOwnProperty('message'))? '' : data.records[i].conversations[0]['message'];
                                timestamp = (!data.records[i].conversations[0].hasOwnProperty('timestamp'))? data.records[i].chatCreate : data.records[i].conversations[0]['timestamp'];
                                html += '<span class="message">' + message + '</span><span class="timestamp">' + formatDate(timestamp) + '</span></div>';
                            }
                            
                            html += '</li>';
                        }

                        $('#chatlist').append(html);

                        //add unread icon if the last message is not read
                        for(var i = 0; i < data.records.length; i++){
                            if(data.records[i].conversations.length > 0){
                                if(!data.records[i].conversations[0].read.includes('' + data.request.userID)){
                                    $('#chatroom'+data.records[i].chatID + ' .left span').addClass('unreadIcon');
                                    $('#chatroom'+data.records[i].chatID + ' .right').addClass('halfWidthRight');
                                }
                            }
                        }
                    }
                }
            });

            var urlParams = new URLSearchParams(window.location.search);
            var uploadImg = urlParams.get('uploadImg');

            if(uploadImg){      
                var data = {
                    icon: uploadImg
                }    
                $.ajax
                ({
                    type: "PATCH",
                    url: "/users/changeUserIcon",
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    async: false,
                    data: JSON.stringify(data),
                    headers: {
                        "authorization": "Bearer " + getCookie('chatJWT')
                    },
                    success:function(data) {
                        $('.img').attr('src', '/content/images/' + data.img);
                    },
                    error:function(data){
                        console.log(data);
                    }
                });

                history.pushState(null, '', '/content/chatlist.html');
            }
        })();

        //Create chat
        $('#createChat').submit(function(event){
            event.preventDefault();
            var data ={
                username:  $('#username').val(),
                chatroom: $('#chatroomName').val()
            }
            
            $.ajax
            ({
                type: "POST",
                url: "/chat/create",
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                async: false,
                data: JSON.stringify(data),
                headers: {
                    "authorization": "Bearer " + getCookie('chatJWT')
                },
                success:function(data) {
                    //insert chatlist data
                    var html='', datetime, datetimeFormat;
                    html += '<li data-id="'+data.records.chatID+'" class="chatroom" id="chatroom'+data.records.chatID+'">' + 
                            '<div class="left"><img src="/content/images/'+ data.records['icon'] +'" class="icon" /></div>' +
                            '<div class="right"><span class="roomName">' + data.records['chatroomName'] + '</span><br/>' +
                            '</li>';
                            
                    $('#chatlist').prepend(html);
                }
            });
        });

        $('#updateName').submit(function (event){
            event.preventDefault();
            var data = {
                username: $('#update-username').val(),
                password: $('#password').val(),
            }
            
            $.ajax
            ({
                type: "PATCH",
                url: "/users/updateUserName",
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                async: false,
                data: JSON.stringify(data),
                headers: {
                    "authorization": "Bearer " + getCookie('chatJWT')
                },
                error:function(data){
                    if(data.status === 400){
                        alert(data.responseJSON.message);
                    }else{
                        alert('Incorrect password');
                    }
                },
                success:function(data) {
                    window.location = '/content/chatlist.html';
                }
            });
        });

        $('#chatlist').delegate( 'li', 'click', function(){
            window.location = '/content/chatroom.html?user='+ encodeURIComponent($('.userID').text()) +'&chatroom=' + $(this).attr('data-id');
        });

        $('.createChatBtn').click(function() {
            $('.createChatContainer').toggle();
        });

        $('.logout').click(function(){
            document.cookie = "chatJWT=; expires = Thu, 01 Jan 1970 00:00:00 GMT"
            window.location = '/login.html';
        });

        $('.moreBtn').click(function() {
            ($('.moreBtn').text() === 'more')? $('.moreBtn').text('less') : $('.moreBtn').text('more');
            $('.moreInfo').toggle();
        });

        const socket = io({query: {"username" : currentUser , 'chat' : allChannel, 'page' : 'chatlist'}}); 
        socket.on('chatroom list update', msg => {
            var roomName = msg.split('#')[0].split(' ')[1];
            var message = msg.split('#')[1];
            var timestamp = msg.split('#')[2];

            $('#chatroom'+roomName+' .message').text(message);
            $('#chatroom'+roomName+' .timestamp').text( formatDate(timestamp) );
            
            $('#chatroom'+roomName + ' .left span').addClass('unreadIcon');
            $('#chatroom'+roomName + ' .right').addClass('halfWidthRight');
            //move the chat to the top
            var originalItem = $('#chatroom'+roomName);
            $('#chatroom'+roomName).remove();
            $('#chatlist').prepend(originalItem);
        });
    </script>
</html>