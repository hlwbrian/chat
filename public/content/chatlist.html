<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>SENAL - Chatrooms list</title>
        <link href="/content/styles/main.css" rel="stylesheet" />
    </head>
    <body class="chatlistPage">
        <div class="chatlistPage__main">
            <!-- show personal info -->
            <div class="userInfo">
                <img class="icon"/>  
                <span class="userID"></span>
                <div class="logout">Log Out</div>
                <div class="moreBtn">more</div>
            </div>

            <!-- create chatroom -->
            <p class="createChatBtn">New Chat</p>
            <div class="chatlistPage__createChat">
                <form id="createChat">
                    <p>Add your friend's' ID: e.g. john#315</p>
                    <input type="text" placeholder="john#315" pattern="[a-z0-9]+#[0-9]+" required id="username">
                    <input type="text" placeholder="chatroom name" required id="chatroomName" minlength="1" maxlength="32">
                    <button type="submit" class="button">create</button>
                </form>
                <div class="errorMsg"></div>
            </div>

            <!-- Chatroom list -->
            <ul id="chatlist"></ul>

            <!-- More options -->
            <div class="moreInfo">
                <div class="details">
                    <h3>Profile</h3>
                    <div class="moreInfo__icon">
                        <img class="icon"/>
                        <div class="overlay">Upload</div>
                    </div>
                    <div class="moreInfo__username">
                        <p>Your name:</p>
                        <textarea class="userID"></textarea>
                        <button class="updateNameBtn" disabled>Update</button>
                    </div>

                    <div class="close"><button class="closeBtn">close</button></div>
                </div>

                <form id="fileUpload" 
                        action='/users/addImage' 
                        method='post' 
                        encType="multipart/form-data">
                    <input name="profileImage" id="profileImageBtn" type="file" />
                    <button type="submit" class="button">Upload</button>
                </form>

                <form id="updateName">
                    <p>Username:</p>
                    <input required type="text" maxlength="32" minlength="1" name="username" pattern="[a-z0-9]+" id="update-username" placeholder="Enter username"></input>
                    <button type="submit" class="button">confirm</button>
                </form>
            </div>
        </div>
    </body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="/content/scripts/common_functions.js"></script>
    <script>
        var currentUser;
        var allChannel = [];
        
        /* Initial page function, load all the chatroom detail for the user */
        (function init(){
            $.ajax
            ({
                type: "GET",
                url: "/chat/getChatList",
                dataType: 'json',
                async: false,
                //get the token from cookie and send to server in request's header
                headers: {
                    "authorization": "Bearer " + getCookie('chatJWT')
                },
                success:function(data) {
                    //Display user information from server
                    $('.phone').text( 'Phone: ' + data.user.phone);
                    $('.email').text( 'Email: ' + data.user.email);
                    $('.userID').text(data.user.username + '#' + data.user.userID);
                    $('.moreInfo__username .userID').text(data.user.username);
                    $('.moreInfo__username .userID').addClass(data.user.username);
                    $('.icon').attr("src", '/content/images/' + data.user.icon);
                    currentUser = data.user.username + '#' + data.user.userID;

                    //Sort the chatroom by time, the chatroom with latest message on top
                    data.records.sort( (a, b) => {
                        let timeA, timeB;
                        timeA = (a.conversations[0])? new Date(a.conversations[0].timestamp) : new Date(a.chatCreate);
                        timeB = (b.conversations[0])? new Date(b.conversations[0].timestamp) : new Date(b.chatCreate);

                        return timeB - timeA;                 
                    });   

                    //Display the chatroom details
                    if(data.records.length > 0){
                        var html = '', datetime, datetimeFormat;
                        for(var i = 0; i < data.records.length; i++){                            
                            html += '<li data-id="'+data.records[i].chatID+'" class="chatroom" id="chatroom'+data.records[i].chatID+'">' + 
                                    '<div class="left"><span></span><img src="/content/images/'+ data.records[i]['icon'] +'" class="icon" /></div>' +
                                    '<div class="right"><span class="roomName">' + data.records[i]['chatroomName'] + '</span><br/>';
                                                                    
                            //Join related chatroom, to listen if any message are send to this user
                            allChannel.push(data.records[i].chatID);
                            if(data.records[i].conversations.length > 0){
                                
                                let message, timestamp;
                                message = (!data.records[i].conversations[0].hasOwnProperty('message'))? '' : data.records[i].conversations[0]['message'];
                                timestamp = (!data.records[i].conversations[0].hasOwnProperty('timestamp'))? data.records[i].chatCreate : data.records[i].conversations[0]['timestamp'];
                                html += '<span class="message">' + message + '</span><span class="timestamp">' + formatDate(timestamp) + '</span></div>';
                            }
                            
                            html += '</li>';
                        }

                        $('#chatlist').append(html);

                        //Add unread remark for the channel that this user have not read yet
                        for(var i = 0; i < data.records.length; i++){
                            if(data.records[i].conversations.length > 0){
                                if(!data.records[i].conversations[0].read.includes('' + data.user.userID)){
                                    $('#chatroom'+data.records[i].chatID + ' .left span').addClass('unreadIcon');
                                    $('#chatroom'+data.records[i].chatID + ' .right').addClass('halfWidthRight');
                                }
                            }
                        }
                    }
                }
            });

            //get all the params
            var urlParams = new URLSearchParams(window.location.search);
            /*
            When upload an image,
            server side will first create a copy in /contnet/images,
            if success, server will send a uploadImg param with image name value to user,
            then user will use this info to make the below request
            */
            var uploadImg = urlParams.get('uploadImg');

            //if successfully create a copy in db
            if(uploadImg){      
                //prepare data
                var data = {
                    icon: uploadImg
                }    
                $.ajax
                ({
                    type: "PATCH",
                    url: "/users/changeUserIcon",
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    async: false,
                    data: JSON.stringify(data),
                    headers: {
                        "authorization": "Bearer " + getCookie('chatJWT')
                    },
                    success:function(data) {
                        //if image update success, change the icon
                        $('.moreInfo__icon .icon').attr('src', '/content/images/' + data.img);
                    },
                    error:function(data){
                    }
                });

                //hide the params
                history.pushState(null, '', '/content/chatlist.html');
            }
        })();

        /* Create Chatroom */
        $('#createChat').submit(function(event){
            //prevent reload
            event.preventDefault();

            //prepare data
            var data ={
                username:  $('#username').val(),
                chatroom: $('#chatroomName').val()
            }
            
            $.ajax
            ({
                type: "POST",
                url: "/chat/create",
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                async: false,
                data: JSON.stringify(data),
                headers: {
                    "authorization": "Bearer " + getCookie('chatJWT')
                },
                success:function(data) {
                    //insert chatlist data
                    var html='', datetime, datetimeFormat;
                    html += '<li data-id="'+data.records.chatID+'" class="chatroom" id="chatroom'+data.records.chatID+'">' + 
                            '<div class="left"><img src="/content/images/'+ data.records['icon'] +'" class="icon" /></div>' +
                            '<div class="right"><span class="roomName">' + data.records['chatroomName'] + '</span><br/>' +
                            '</li>';
                            
                    $('#chatlist').prepend(html);
                }
            });
        });

        /* Update personal information */
        $('#updateName').submit(function (event){
            //prevent reload
            event.preventDefault();

            //prepare data
            var data = {
                username: $('#update-username').val(),
                password: $('#password').val(),
            }
            
            $.ajax
            ({
                type: "PATCH",
                url: "/users/updateUserName",
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                async: false,
                data: JSON.stringify(data),
                headers: {
                    "authorization": "Bearer " + getCookie('chatJWT')
                },
                error:function(data){
                    if(data.status === 400){
                        alert(data.responseJSON.message);
                    }else{
                        alert('Incorrect password');
                    }
                },
                success:function(data) {
                    window.location = '/content/chatlist.html';
                }
            });
        });

        /* Event listeners */
        $('#chatlist').delegate( 'li', 'click', function(){
            window.location = '/content/chatroom.html?user='+ encodeURIComponent($('.userID').text()) +'&chatroom=' + $(this).attr('data-id');
        });

        $('.createChatBtn').click(function() {
            $('.chatlistPage__createChat').toggle();
        });

        $('.logout').click(function(){
            document.cookie = "chatJWT=; expires = Thu, 01 Jan 1970 00:00:00 GMT"
            window.location = '/content/login.html';
        });

        $('.moreBtn').click(function() {
            ($('.moreBtn').text() === 'more')? $('.moreBtn').text('less') : $('.moreBtn').text('more');
            $('.moreInfo').toggle();
        });

        $('.moreInfo__icon .overlay').click(function() {
            $('#profileImageBtn').trigger('click');
       });

       $('#profileImageBtn:file').change(function (){
           $('#fileUpload .button').trigger('click');
        });

        $('.moreInfo__username textarea').on('input', function(){
            if( !$('.moreInfo__username textarea').hasClass($('.moreInfo__username textarea').val()) ){
                $('.updateNameBtn').prop('disabled', false);
            }else{
                $('.updateNameBtn').prop('disabled', true);
            }
        });

        $('.moreInfo .closeBtn').click(function(){
            $('.moreInfo').css('display', 'none');
        })

        $('.updateNameBtn').click(function() {
            $('#update-username').val($('.moreInfo__username .userID').val().toLowerCase());
            $('#updateName .button').trigger('click');
        });

        const socket = io({query: {"username" : currentUser , 'chat' : allChannel, 'page' : 'chatlist'}}); 

        //socket listen to the chatroom that has message sent out
        socket.on('chatroom list update', msg => {
            var roomName = msg.split('#')[0].split(' ')[1];
            var message = msg.split('#')[1];
            var timestamp = msg.split('#')[2];

            $('#chatroom'+roomName+' .message').text(message);
            $('#chatroom'+roomName+' .timestamp').text( formatDate(timestamp) );
            
            $('#chatroom'+roomName + ' .left span').addClass('unreadIcon');
            $('#chatroom'+roomName + ' .right').addClass('halfWidthRight');
            //move the chat to the top
            var originalItem = $('#chatroom'+roomName);
            $('#chatroom'+roomName).remove();
            $('#chatlist').prepend(originalItem);
        });
    </script>
</html>