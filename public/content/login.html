<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Beacon - Login</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <link href="/content/styles/main.css" rel="stylesheet" />
    </head>
    <body class="loginPage">
        <div class="loginPage__header">
            <div>
                <img class="chatIcon" src="/content/images/chat_icon.png" alt="app icon" />
                <h1>Beacon</h1>
            </div>
        </div>

        <div class="loginPage__main">
            <div class="loginPage__form">
                <div class="loginPage__form-login">
                    <h2>Log In</h2>
                    <form id="loginForm" action="">
                        <p>Username:</p>
                        <input type="text" required maxlength="32" minlength="1" name="username" id="login-username" placeholder="Enter your username:"></input>

                        <p>Password:</p>
                        <input type="password" required minlength="6" maxlength="16" name="password" id="login-password" placeholder="Enter your password:"></input>
                        
                        <div class="errorMsg"></div>
                        <div class="loginBtn">
                            <button type="submit" class="loginSubmit button">submit</button>
                            <button type="button" class="register button">Register</button>
                        </div>
                    </form>
                </div>
                <div class="loginPage__form-signup">
                    <h2>Sign up</h2>
                    <form id="signupForm" action="">
                        <p>Username:</p>
                        <input required type="text" maxlength="32" minlength="1" name="username" pattern="[a-z0-9]+" id="signup-username" placeholder="Enter username"></input>
                        <p>Password:</p>
                        <input required type="password" name="password" minlength="6" maxlength="16" id="signup-password" placeholder="Enter password"></input>
                        <p>Password confirm:</p>
                        <input required type="password" name="passwordConfirm"  minlength="6" maxlength="16" id="passwordConfirm" oninput="confirmCheck(this)" placeholder="Enter password again"></input>
                        <p>Email:</p>
                        <input required type="email" name="email" id="email" placeholder="Enter email"></input>
                        <p>Phone:</p>
                        <input required type="tel" name="phoneNo" id="phoneNo" pattern="[9|8|5|2]{1}[0-9]{7}" placeholder="Enter phone"></input>
                        
                        <div class="errorMsg"></div>
                        <div class="loginBtn">
                            <button type="submit" class="button" id="signupBtn">submit</button>
                            <button type="button" class="register button">Log in</button>
                        </div>
                    </form>
                </div>    
            </div>
        </div>

        <div class="loginPage__footer">
            <div class="container">
                <div class="left">
                    <div> 
                        <span class="copyright">© 2013–2021 Beacon, a 501c3 nonprofit.</span><br> 
                        Beacon is a registered trademark in the United States and other countries. <br> <br> 
                        For media inquiries, contact <a href="#">info@beacon.org</a></div>
                </div>

                <div class="right">
                    <div class="container">
                        <div class="columns">
                            <div class="column"> 
                                <strong>Company</strong>
                                <ul>
                                    <li> <a href="#">Donate</a></li>
                                    <li> <a href="#">Careers</a></li>
                                    <li> <a href="#">Blog</a></li>
                                    <li> <a href="#">Terms &amp; Privacy Policy</a></li>
                                </ul>
                            </div>
                            <div class="column"> 
                                <strong>Download</strong>
                                <ul>
                                    <li> <a href="#">Android</a></li>
                                    <li> <a href="#">iPhone &amp; iPad</a></li>
                                    <li> <a href="#">Windows</a></li>
                                    <li> <a href="#">Mac</a></li>
                                    <li> <a href="#">Linux</a></li>
                                </ul>
                            </div>
                            <div class="column"> 
                                <strong>Social</strong>
                                <ul>
                                    <li> <a href="#" target="_blank">GitHub</a></li>
                                    <li> <a href="#" target="_blank">Twitter</a></li>
                                    <li> <a href="#" target="_blank">Instagram</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <script>
        //FROM login page
        $('#signupForm').submit( function(event) {
            event.preventDefault();

            var data = {
                username : $('#signup-username').val(),
                password : $('#signup-password').val(),
                passwordConfirm : $('#passwordConfirm').val(),
                email : $('#email').val(),
                phoneNo : $('#phoneNo').val()
            }

            $.ajax({
                type: 'POST',
                url: '/users/signup',
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                async: false,
                data: JSON.stringify(data),
                error: function(err){              
                    if(err.responseJSON.error.statusCode === 400){
                        var fieldName = err.responseJSON.message.substring(err.responseJSON.message.lastIndexOf(':') + 1).trim();
                        if(fieldName === 'phoneNo') fieldName = 'phone number';
                        var errMsg = 'Please use another value for ' + fieldName;
                        $('.loginPage__form-signup .errorMsg').html(errMsg);
                    }
                },
                success: function(data){
                    //if signup successful, then go to chatlist page
                    window.location = '/content/chatlist.html';
                }                
            });
        });

        //Common function
        function login(){
            var data = {
                username : $('#login-username').val(),
                password : $('#login-password').val()
            }
            
            $.ajax({
                type: 'POST',
                url: '/users/login',
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                async: false,
                data: JSON.stringify(data),
                error: function(err){
                    if(err.status === 404){
                        var errMsg = '*Incorrect password or username, please check again.';
                        $('.loginPage__form-login .errorMsg').html(errMsg);
                    }
                },
                success: function(){
                    window.location = '/content/chatlist.html';
                }
            });
        }

        $('#loginForm').submit( function(event) {
            event.preventDefault();
            login();
        });

        //function that check if password confirm are matched
        function confirmCheck(input) {
            if (input.value === $('#signup-password').val()) {
                $('#confirmText').hide();
                $('#signupBtn').prop('disabled', false);
            }else{
                $('#confirmText').show();
            }
        }

        $('.register').click(function(){
            $('.loginPage__form-login').toggle();
            $('.loginPage__form-signup').toggle();
        });
    </script>
</html>